var babble = {
    currentMessage: " ",
    userInfo: {
        name : " ",
        email : " "
    }
};


/* Get input from user and disappear Modal */
 window.onload = function () {
    var x = document.getElementById('info'); 
    //enlarge the user counter
    var userCntr =Number(document.getElementById("cntUsers").innerHTML)+1;

    document.getElementById('Anonymous').onclick = function () {
            document.getElementById('modal').style.display = "none";
            babble.userInfo.name= 'Anonymous';
            babble.userInfo.email= 'Anonymous';
            document.getElementById("cntUsers").innerHTML = userCntr;
        };
        document.getElementById('Save').onclick = function () {
            //make Sure the email address in valid
            if(x.elements[1].value.search("@") == -1)
            {
                alert("Please insert correct Email Address!");
                babble.userInfo.email = "";
            }
            else{
            babble.userInfo.name = x.elements[0].value; //saves the user name
            babble.userInfo.email = x.elements[1].value; //saves the user email
            document.getElementById('modal').style.display = "none";
            document.getElementById("cntUsers").innerHTML = userCntr;
            }
        };
    };

function checkTime(i) {
  if (i < 10) {
    i = "0" + i;
  }
  return i;
}


/* Rezise the textarea according to text (till 300px) */
function resizeTextarea(ev) {
    ev.style.height = '90px';
    if (ev.scrollHeight <=300 && ev.scrollHeight >=70)
    {
        ev.style.height = ev.scrollHeight + 'px';
    }
    if(ev.scrollHeight > 300)
    {
        ev.style.height = 300 + 'px';
    }
    document.getElementById("footer").style.height = ev.style.height;
}

/* Post Message */
function postMessage() {
    var textArea = document.getElementById("newMessage");
    babble.currentMessage = textArea.elements[0].value; //saves the user name
    
    document.getElementById("footer").style.height = "90px";
    document.getElementById("textArea").style.height = "90px";
    
    var ol = document.getElementById("ol_AllMessages");
    var li = document.createElement("li");

    // Update message counter
    var messageCounter = ol.children.length + 1;
    document.getElementById("cntMsg").innerHTML = messageCounter;

    // Gives the new message an id 
    if (messageCounter == 1)  {
        li.setAttribute("id", "element1");
    }
    else{
        var lastMsg = Number(ol.lastChild.id.charAt(7)) +1;
        li.setAttribute("id", "element"+lastMsg);
    }

    // Add user image
    var userImg = document.createElement("img");
    if (babble.userInfo.name == "Anonymous"){
            userImg.setAttribute('src', 'images/ann.png');
            userImg.setAttribute('border', '1px, solid, #d7d7d7');
        }else{
            //TODO: GRAVATAR BY THE EMAIL
            userImg.setAttribute('src', 'images/roni.jpg');
        }
    userImg.setAttribute('class', 'logos');
    userImg.setAttribute('alt', ' ');
    li.appendChild(userImg);

    // Add  div wrapping the Name, hour and message text
    var boxMsg = document.createElement("div");
    boxMsg.setAttribute('tabindex', messageCounter);
    // User name
    var userName = document.createElement("cite");
    userName.appendChild(document.createTextNode(babble.userInfo.name));
    userName.setAttribute('class', 'name');
    boxMsg.appendChild(userName);

    // Hour the message sent
    var DATE = new Date();
    var h = checkTime(DATE.getHours());
    var m = checkTime(DATE.getMinutes());
    var curTime = document.createTextNode(h + ":" + m);

    var time = document.createElement("time");
    time.appendChild(curTime);
    time.setAttribute('class', 'hour');
    time.setAttribute('datatime', h + ":" + m);
    boxMsg.appendChild(time);

    // Close button
    var close = document.createElement("button");
    close.appendChild(document.createTextNode("x"));
    close.setAttribute('class', 'delete');
    close.setAttribute('aria-label', 'closeButton');
    //close.setAttribute('tabindex', messageCounter);
    close.setAttribute('onclick','deleteMessage(this);');
    boxMsg.appendChild(close);

    // New message text
    var newMsg = document.createElement("p");
    newMsg.appendChild(document.createTextNode(babble.currentMessage));
    newMsg.setAttribute('class', 'newMsgTxt');
    boxMsg.appendChild(newMsg);
    boxMsg.setAttribute('class', 'boxmessage');
    li.appendChild(boxMsg);

    // Add new li to ol
    ol.appendChild(li);
    document.getElementById("textArea").value='';
}

/* Send Message with 'enter' key */
document.getElementById("textArea")
    .addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode == 13) {
        postMessage();
        window.location = "#newestMsg"; //show us always the last message
    }
});

/* Delete Message and update message counter */
function deleteMessage(el) {
    var ol = document.getElementById("ol_AllMessages"); //get ol as parent of el li
    var child = el.parentElement.parentElement; //the current li
    ol.removeChild(child);

    //update msgCnt
    document.getElementById("cntMsg").innerHTML = ol.children.length;
}

//AJAX
xmlhttp = new XMLHttpRequest();
var poll = function(){
  xmlhttp.open('GET', 'http://localhost:8080/messages?counter='+counter);
  xmlhttp.addEventListener("readystatechange", xmlhttp.onreadystatechange);
  xmlhttp.send();
};
poll();

xmlhttp.onreadystatechange = function (response) {
  var DONE = 4; // readyState 4 means the request is done.
  var OK = 200; // status 200 is a successful return.
  if (xmlhttp.readyState === DONE) {
    if (xmlhttp.status === OK) {
      console.log("server: " + xmlhttp.responseText); // 'This is the returned text.'
      counter++;
      
    }
      poll();
    }
    
};